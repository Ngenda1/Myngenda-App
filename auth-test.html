<link rel="icon" href="favicon.ico" sizes="any">
<link rel="icon" href="icons/myngenda-icon.png" type="image/png">
<link rel="apple-touch-icon" href="icons/myngenda-icon.png"><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyNgenda Authentication Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      color: #4CAF50;
    }
    .card {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
    .test-banner {
      background-color: #ffeb3b;
      color: #333;
      text-align: center;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 4px;
      border: 2px dashed #f57c00;
      font-weight: bold;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 15px;
      cursor: pointer;
    }
    .tab.active {
      border-bottom: 2px solid #4CAF50;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    #userInfo {
      display: none;
    }
  </style>
</head>
<body>
  <div class="test-banner">
    DEPLOYMENT TEST - May 2025
    <div>If you can see this yellow box, the deployment is working correctly!</div>
  </div>
  
  <h1>MyNgenda Authentication Test</h1>
  <p>This page tests the enhanced token-based authentication system for external users.</p>
  
  <div class="tabs">
    <div class="tab active" onclick="showTab('register')">Register</div>
    <div class="tab" onclick="showTab('login')">Login</div>
    <div class="tab" onclick="showTab('protected')">Protected</div>
  </div>
  
  <div id="registerTab" class="tab-content active">
    <h2>Register</h2>
    <div class="card">
      <form id="registerForm">
        <div class="form-group">
          <label for="registerFirstName">First Name</label>
          <input type="text" id="registerFirstName" required>
        </div>
        <div class="form-group">
          <label for="registerLastName">Last Name</label>
          <input type="text" id="registerLastName" required>
        </div>
        <div class="form-group">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" required>
        </div>
        <div class="form-group">
          <label for="registerPhoneNumber">Phone Number</label>
          <input type="text" id="registerPhoneNumber" required>
        </div>
        <div class="form-group">
          <label for="registerPassword">Password</label>
          <input type="password" id="registerPassword" required>
        </div>
        <div class="form-group">
          <label for="registerRole">Role</label>
          <select id="registerRole">
            <option value="user">User</option>
            <option value="driver">Driver</option>
          </select>
        </div>
        <button type="submit">Register</button>
      </form>
      <div id="registerMessage" class="message" style="display:none;"></div>
    </div>
  </div>
  
  <div id="loginTab" class="tab-content">
    <h2>Login</h2>
    <div class="card">
      <form id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" required>
        </div>
        <button type="submit">Login</button>
      </form>
      <div id="loginMessage" class="message" style="display:none;"></div>
    </div>
  </div>
  
  <div id="protectedTab" class="tab-content">
    <h2>Protected Resources</h2>
    <div class="card">
      <button id="getProfileBtn">Get Profile</button>
      <button id="logoutBtn">Logout</button>
      <div id="protectedMessage" class="message" style="display:none;"></div>
    </div>
  </div>
  
  <div id="userInfo" class="card">
    <h2>User Information</h2>
    <div id="userInfoContent"></div>
  </div>
  
  <script>
    // Show tab function
    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      document.querySelectorAll('.tab').forEach(tab => {
        if (tab.textContent.toLowerCase() === tabName) {
          tab.classList.add('active');
        }
      });
    }
    
    // Show message function
    function showMessage(id, text, type) {
      const messageEl = document.getElementById(id);
      messageEl.textContent = text;
      messageEl.className = 'message ' + type;
      messageEl.style.display = 'block';
      
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 5000);
    }
    
    // Display user info
    function displayUserInfo(user) {
      const userInfoEl = document.getElementById('userInfo');
      const userInfoContentEl = document.getElementById('userInfoContent');
      
      userInfoContentEl.innerHTML = `
        <p><strong>ID:</strong> ${user.id}</p>
        <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
        <p><strong>Email:</strong> ${user.email}</p>
        <p><strong>Phone:</strong> ${user.phoneNumber}</p>
        <p><strong>Role:</strong> ${user.role}</p>
        <p><strong>Status:</strong> ${user.status}</p>
      `;
      
      userInfoEl.style.display = 'block';
    }
    
    // Save token function
    function saveToken(token) {
      localStorage.setItem('auth_token', token);
    }
    
    // Get token function
    function getToken() {
      return localStorage.getItem('auth_token');
    }
    
    // Register form handler
    document.getElementById('registerForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      
      try {
        const response = await fetch('/api/token/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            firstName: document.getElementById('registerFirstName').value,
            lastName: document.getElementById('registerLastName').value,
            email: document.getElementById('registerEmail').value,
            phoneNumber: document.getElementById('registerPhoneNumber').value,
            password: document.getElementById('registerPassword').value,
            role: document.getElementById('registerRole').value
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showMessage('registerMessage', 'Registration successful!', 'success');
          document.getElementById('registerForm').reset();
          
          if (result.token) {
            saveToken(result.token);
            displayUserInfo(result.user);
            showTab('protected');
          }
        } else {
          showMessage('registerMessage', result.message || 'Registration failed', 'error');
        }
      } catch (error) {
        console.error('Registration error:', error);
        showMessage('registerMessage', 'Error connecting to server', 'error');
      }
    });
    
    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      
      try {
        const response = await fetch('/api/token/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: document.getElementById('loginEmail').value,
            password: document.getElementById('loginPassword').value
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showMessage('loginMessage', 'Login successful!', 'success');
          document.getElementById('loginForm').reset();
          
          if (result.token) {
            saveToken(result.token);
            displayUserInfo(result.user);
            showTab('protected');
          }
        } else {
          showMessage('loginMessage', result.message || 'Login failed', 'error');
        }
      } catch (error) {
        console.error('Login error:', error);
        showMessage('loginMessage', 'Error connecting to server', 'error');
      }
    });
    
    // Get profile button handler
    document.getElementById('getProfileBtn').addEventListener('click', async () => {
      const token = getToken();
      
      if (!token) {
        showMessage('protectedMessage', 'You need to login first', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/token/current-user', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (response.ok) {
          displayUserInfo(result.user);
          showMessage('protectedMessage', 'Profile loaded successfully', 'success');
        } else {
          showMessage('protectedMessage', result.message || 'Failed to get profile', 'error');
        }
      } catch (error) {
        console.error('Get profile error:', error);
        showMessage('protectedMessage', 'Error connecting to server', 'error');
      }
    });
    
    // Logout button handler
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('auth_token');
      document.getElementById('userInfo').style.display = 'none';
      showMessage('protectedMessage', 'Logged out successfully', 'success');
      showTab('login');
    });
    
    // Check if user is already logged in
    async function checkAuth() {
      const token = getToken();
      
      if (!token) {
        return;
      }
      
      try {
        const response = await fetch('/api/token/current-user', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          displayUserInfo(result.user);
          showTab('protected');
        }
      } catch (error) {
        console.error('Auth check error:', error);
      }
    }
    
    // Check auth on page load
    checkAuth();
  </script>
</body>
</html>
