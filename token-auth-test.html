
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token Authentication Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2 {
      color: #4CAF50;
    }
    .card {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <h1>Token Authentication Test</h1>
  <p>This page tests the new token-based authentication for external users.</p>
  
  <div class="card">
    <h2>Register</h2>
    <form id="registerForm">
      <div class="form-group">
        <label for="registerFirstName">First Name</label>
        <input type="text" id="registerFirstName" required>
      </div>
      <div class="form-group">
        <label for="registerLastName">Last Name</label>
        <input type="text" id="registerLastName" required>
      </div>
      <div class="form-group">
        <label for="registerEmail">Email</label>
        <input type="email" id="registerEmail" required>
      </div>
      <div class="form-group">
        <label for="registerPhoneNumber">Phone Number</label>
        <input type="text" id="registerPhoneNumber" required>
      </div>
      <div class="form-group">
        <label for="registerPassword">Password</label>
        <input type="password" id="registerPassword" required>
      </div>
      <button type="submit">Register</button>
    </form>
    <div id="registerMessage" class="message" style="display:none;"></div>
  </div>
  
  <div class="card">
    <h2>Login</h2>
    <form id="loginForm">
      <div class="form-group">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" required>
      </div>
      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" required>
      </div>
      <button type="submit">Login</button>
    </form>
    <div id="loginMessage" class="message" style="display:none;"></div>
  </div>
  
  <div class="card">
    <h2>Test Protected Route</h2>
    <button id="testButton" disabled>Test Protected Route</button>
    <div id="testMessage" class="message" style="display:none;"></div>
  </div>
  
  <div class="card">
    <h2>Current User</h2>
    <div id="userInfo">Not logged in</div>
    <button id="logoutButton" style="display:none;">Logout</button>
  </div>
  
  <script>
    // ===== Register Form =====
    document.getElementById('registerForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      
      const registerMessage = document.getElementById('registerMessage');
      registerMessage.style.display = 'none';
      
      try {
        const response = await fetch('/api/token/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            firstName: document.getElementById('registerFirstName').value,
            lastName: document.getElementById('registerLastName').value,
            email: document.getElementById('registerEmail').value,
            phoneNumber: document.getElementById('registerPhoneNumber').value,
            password: document.getElementById('registerPassword').value
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          registerMessage.textContent = 'Registration successful!';
          registerMessage.className = 'message success';
          registerMessage.style.display = 'block';
          
          // Save token and update UI
          if (result.token) {
            localStorage.setItem('auth_token', result.token);
            updateUserInfo(result);
            document.getElementById('registerForm').reset();
          }
        } else {
          registerMessage.textContent = result.message || 'Registration failed';
          registerMessage.className = 'message error';
          registerMessage.style.display = 'block';
        }
      } catch (error) {
        console.error('Registration error:', error);
        registerMessage.textContent = 'Error connecting to server';
        registerMessage.className = 'message error';
        registerMessage.style.display = 'block';
      }
    });
    
    // ===== Login Form =====
    document.getElementById('loginForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      
      const loginMessage = document.getElementById('loginMessage');
      loginMessage.style.display = 'none';
      
      try {
        const response = await fetch('/api/token/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: document.getElementById('loginEmail').value,
            password: document.getElementById('loginPassword').value
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          loginMessage.textContent = 'Login successful!';
          loginMessage.className = 'message success';
          loginMessage.style.display = 'block';
          
          // Save token and update UI
          if (result.token) {
            localStorage.setItem('auth_token', result.token);
            updateUserInfo(result);
            document.getElementById('loginForm').reset();
          }
        } else {
          loginMessage.textContent = result.message || 'Login failed';
          loginMessage.className = 'message error';
          loginMessage.style.display = 'block';
        }
      } catch (error) {
        console.error('Login error:', error);
        loginMessage.textContent = 'Error connecting to server';
        loginMessage.className = 'message error';
        loginMessage.style.display = 'block';
      }
    });
    
    // ===== Test Protected Route =====
    document.getElementById('testButton').addEventListener('click', async () => {
      const testMessage = document.getElementById('testMessage');
      testMessage.style.display = 'none';
      
      const token = localStorage.getItem('auth_token');
      
      if (!token) {
        testMessage.textContent = 'You must be logged in to access protected routes';
        testMessage.className = 'message error';
        testMessage.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch('/api/deliveries', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          testMessage.textContent = 'Protected route access successful! Data received.';
          testMessage.className = 'message success';
          testMessage.style.display = 'block';
        } else {
          const result = await response.json();
          testMessage.textContent = result.message || 'Access denied';
          testMessage.className = 'message error';
          testMessage.style.display = 'block';
        }
      } catch (error) {
        console.error('Protected route error:', error);
        testMessage.textContent = 'Error connecting to server';
        testMessage.className = 'message error';
        testMessage.style.display = 'block';
      }
    });
    
    // ===== Logout =====
    document.getElementById('logoutButton').addEventListener('click', () => {
      localStorage.removeItem('auth_token');
      updateUserInfo(null);
    });
    
    // ===== Update User Info =====
    function updateUserInfo(user) {
      const userInfo = document.getElementById('userInfo');
      const testButton = document.getElementById('testButton');
      const logoutButton = document.getElementById('logoutButton');
      
      if (user) {
        userInfo.innerHTML = `
          <p><strong>ID:</strong> ${user.id}</p>
          <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
          <p><strong>Email:</strong> ${user.email}</p>
          <p><strong>Role:</strong> ${user.role}</p>
        `;
        testButton.disabled = false;
        logoutButton.style.display = 'block';
      } else {
        userInfo.textContent = 'Not logged in';
        testButton.disabled = true;
        logoutButton.style.display = 'none';
      }
    }
    
    // ===== Check Authentication on Load =====
    async function checkAuth() {
      const token = localStorage.getItem('auth_token');
      
      if (!token) {
        return;
      }
      
      try {
        const response = await fetch('/api/token/current-user', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.ok) {
          const user = await response.json();
          updateUserInfo(user);
        } else {
          // Token invalid, clear it
          localStorage.removeItem('auth_token');
        }
      } catch (error) {
        console.error('Auth check error:', error);
      }
    }
    
    // Check authentication on page load
    checkAuth();
  </script>
</body>
</html>
